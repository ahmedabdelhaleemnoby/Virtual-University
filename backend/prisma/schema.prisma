// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  ADMIN
  INSTRUCTOR
  STUDENT
}

enum EnrollmentStatus {
  PENDING
  PAYMENT_PROCESSING
  ACTIVE
  COMPLETED
  EXPIRED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentProvider {
  STRIPE
  PAYMOB
  PAYPAL
}

enum VideoProvider {
  GOOGLE_DRIVE
  VIMEO
  S3_CLOUDFRONT
  BUNNY_STREAM
}

enum DifficultyLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

// ============================================
// CORE TABLES
// ============================================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String
  role          UserRole  @default(STUDENT)
  
  firstName     String
  lastName      String
  country       String?
  phone         String?
  avatarUrl     String?
  bio           String?
  
  emailVerifiedAt DateTime?
  verificationToken String?
  
  passwordResetToken String?
  passwordResetExpiresAt DateTime?
  lastLoginAt   DateTime?
  
  isActive      Boolean   @default(true)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  subjects      Subject[] @relation("InstructorSubjects")
  enrollments   Enrollment[]
  payments      Payment[]
  examAttempts  ExamAttempt[]
  certificates  Certificate[]
  logs          ActivityLog[]
}

model Faculty {
  id           String       @id @default(uuid())
  name         String
  slug         String       @unique
  description  String?
  imageUrl     String?
  displayOrder Int          @default(0)
  isActive     Boolean      @default(true)
  
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  departments  Department[]
}

model Department {
  id           String    @id @default(uuid())
  facultyId    String
  faculty      Faculty   @relation(fields: [facultyId], references: [id], onDelete: Cascade)
  
  name         String
  slug         String    @unique
  description  String?
  imageUrl     String?
  displayOrder Int       @default(0)
  isActive     Boolean   @default(true)
  
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  subjects     Subject[]
}

model Subject {
  id              String          @id @default(uuid())
  departmentId    String
  department      Department      @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  instructorId    String?
  instructor      User?           @relation("InstructorSubjects", fields: [instructorId], references: [id])
  
  title           String
  slug            String          @unique
  description     String?
  imageUrl        String?
  
  price           Decimal         @db.Decimal(10, 2)
  currency        String          @default("USD")
  
  durationWeeks   Int?
  difficultyLevel DifficultyLevel @default(BEGINNER)
  prerequisites   String?
  learningOutcomes String?
  
  videoProvider   VideoProvider   @default(GOOGLE_DRIVE)
  metadata        Json?           @default("{}")
  
  isPublished     Boolean         @default(false)
  publishedAt     DateTime?
  
  enrollmentsCount Int            @default(0)
  averageRating    Decimal        @default(0) @db.Decimal(3, 2)
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  enrollments     Enrollment[]
  videos          VideoLecture[]
  exams           Exam[]
  materials       LearningMaterial[]
  certificateTemplates CertificateTemplate[]
}

model Enrollment {
  id           String           @id @default(uuid())
  studentId    String
  student      User             @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subjectId    String
  subject      Subject          @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  paymentId    String?          @unique
  payment      Payment?         @relation(fields: [paymentId], references: [id])
  
  status       EnrollmentStatus @default(PENDING)
  
  enrolledAt   DateTime?
  completedAt  DateTime?
  expiresAt    DateTime?
  progress     Json?            @default("{}")
  
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  videoAccess  VideoAccess[]
  certificate  Certificate?

  @@unique([studentId, subjectId])
}

model Payment {
  id                String          @id @default(uuid())
  userId            String
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  enrollmentId      String?         
  
  provider          PaymentProvider
  providerPaymentId String?         @unique
  
  amount            Decimal         @db.Decimal(10, 2)
  currency          String
  
  status            PaymentStatus   @default(PENDING)
  metadata          Json?           @default("{}")
  
  paidAt            DateTime?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  enrollment        Enrollment?
}

model VideoLecture {
  id              String        @id @default(uuid())
  subjectId       String
  subject         Subject       @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  
  title           String
  description     String?
  
  providerVideoId String
  videoProvider   VideoProvider @default(GOOGLE_DRIVE)
  
  durationSeconds Int?
  thumbnailUrl    String?
  displayOrder    Int           @default(0)
  
  isPreview       Boolean       @default(false)
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  videoAccess     VideoAccess[]
}

model VideoAccess {
  id              String        @id @default(uuid())
  enrollmentId    String
  enrollment      Enrollment    @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  videoLectureId  String
  videoLecture    VideoLecture  @relation(fields: [videoLectureId], references: [id], onDelete: Cascade)
  
  grantedAt       DateTime      @default(now())
  revokedAt       DateTime?
  lastAccessedAt  DateTime?
  
  watchTimeSeconds     Int      @default(0)
  completionPercentage Int      @default(0)

  @@unique([enrollmentId, videoLectureId])
}

model LearningMaterial {
  id            String    @id @default(uuid())
  subjectId     String
  subject       Subject   @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  
  title         String
  description   String?
  fileUrl       String
  fileType      String?
  fileSizeBytes BigInt?
  
  displayOrder  Int       @default(0)
  isPreview     Boolean   @default(false)
  
  createdAt     DateTime  @default(now())
}

model Exam {
  id                String        @id @default(uuid())
  subjectId         String
  subject           Subject       @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  
  title             String
  description       String?
  
  durationMinutes   Int
  passingScore      Int
  maxAttempts       Int           @default(3)
  
  questions         Json
  
  randomizeQuestions Boolean      @default(false)
  randomizeOptions   Boolean      @default(false)
  
  isPublished       Boolean       @default(false)
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  attempts          ExamAttempt[]
}

model ExamAttempt {
  id            String    @id @default(uuid())
  examId        String
  exam          Exam      @relation(fields: [examId], references: [id], onDelete: Cascade)
  studentId     String
  student       User      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  startedAt     DateTime  @default(now())
  submittedAt   DateTime?
  
  answers       Json?
  
  score         Int?
  passed        Boolean?
  
  ipAddress     String?
  userAgent     String?
}

model CertificateTemplate {
  id           String    @id @default(uuid())
  subjectId    String?   
  subject      Subject?  @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  
  name         String
  templateData Json
  
  isActive     Boolean   @default(true)
  
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  certificates Certificate[]
}

model Certificate {
  id                String              @id @default(uuid())
  enrollmentId      String              @unique
  enrollment        Enrollment          @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  studentId         String
  student           User                @relation(fields: [studentId], references: [id], onDelete: Cascade)
  templateId        String?
  template          CertificateTemplate? @relation(fields: [templateId], references: [id])
  
  certificateNumber String              @unique
  verificationCode  String              @unique
  
  pdfUrl            String?
  qrCodeData        String?
  
  metadata          Json?               @default("{}")
  
  issuedAt          DateTime            @default(now())
  expiresAt         DateTime?
}

model ActivityLog {
  id            String    @id @default(uuid())
  userId        String?
  user          User?     @relation(fields: [userId], references: [id])
  
  action        String
  resourceType  String?
  resourceId    String?
  
  metadata      Json?     @default("{}")
  
  createdAt     DateTime  @default(now())
}
